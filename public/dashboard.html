<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Blood Request Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Pre-compiled Tailwind CSS */
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:Sarabun,sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,[type='button'],[type='reset'],[type='submit']{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button, [role="button"]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }
        /* Custom Styles */
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .status-pill { padding: 4px 12px; border-radius: 9999px; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-submitted { background-color: #dbeafe; color: #1e40af; }
        .status-in_progress { background-color: #e0e7ff; color: #3730a3; }
        .status-delivered { background-color: #dcfce7; color: #166534; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .component-pill { padding: 5px 12px; border-radius: 8px; font-weight: 600; color: white; text-align: center; }
        .component-redcell { background-color: #dc2626; }
        .component-ffp { background-color: #d97706; }
        .component-cryoprecipitate { background-color: #0284c7; }
        .component-unknown { background-color: #64748b; }
        .highlight-blank { background-color: #fef9c3 !important; outline: 2px solid #facc15; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; translateY(0); } }
        .new-row { animation: fadeIn 0.5s ease-out; background-color: #cffafe !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Blood Request Dashboard</h1>
                <p class="text-slate-500">Real-time requests from hospital wards</p>
            </div>
            <div id="connection-status" class="flex items-center gap-2 text-lg font-semibold">
                <div class="w-4 h-4 rounded-full bg-amber-400 animate-pulse"></div>
                <span>Connecting...</span>
            </div>
        </header>

        <main class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">Patient / HN</th>
                            <th scope="col" class="px-6 py-3">Component</th>
                            <th scope="col" class="px-6 py-3">Details</th>
                            <th scope="col" class="px-6 py-3">Ward</th>
                            <th scope="col" class="px-6 py-3">Delivery</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3">Requested At</th>
                            <th scope="col" class="px-6 py-3">Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="requests-table-body">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
            connectToSSE();
        });

        const API_BASE_URL = '/api';

        async function fetchInitialData() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_requests`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const tableBody = document.getElementById('requests-table-body');
                tableBody.innerHTML = '';
                data.requests.forEach(request => {
                    const row = createRequestRow(request);
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching initial data:", error);
                const tableBody = document.getElementById('requests-table-body');
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-red-500 font-semibold">Failed to load initial requests. Check API connection.</td></tr>`;
            }
        }

        function connectToSSE() {
            const statusDiv = document.getElementById('connection-status');
            const eventSource = new EventSource(`${API_BASE_URL}/sse-updates`);

            eventSource.onopen = () => {
                console.log("SSE Connection Opened");
                statusDiv.innerHTML = `<div class="w-4 h-4 rounded-full bg-green-500"></div><span>Connected</span>`;
            };

            eventSource.onerror = () => {
                console.error("SSE Connection Error. Reconnecting...");
                statusDiv.innerHTML = `<div class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div><span>Disconnected. Retrying...</span>`;
                eventSource.close();
                setTimeout(connectToSSE, 5000);
            };

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("SSE Message Received:", data);

                if (data.type === 'new_request') {
                    handleNewRequest(data);
                } else if (data.type === 'status_update') {
                    handleStatusUpdate(data);
                }
            };
        }

        function handleNewRequest(requestData) {
            const tableBody = document.getElementById('requests-table-body');
            const existingRow = document.getElementById(`request-${requestData.request_id}`);
            if (existingRow) return;

            const row = createRequestRow(requestData);
            row.classList.add('new-row');
            tableBody.prepend(row);

            setTimeout(() => row.classList.remove('new-row'), 5000);
        }

        function handleStatusUpdate(updateData) {
            const row = document.getElementById(`request-${updateData.request_id}`);
            if (!row) return;

            const statusCell = row.querySelector('.status-cell');
            const lastUpdateCell = row.querySelector('.last-update-cell');
            
            statusCell.innerHTML = createStatusDropdown(updateData.request_id, updateData.status);
            lastUpdateCell.textContent = formatDateTime(updateData.updated_at);
            
            row.querySelector('.status-dropdown').addEventListener('change', handleStatusChange);
            row.classList.add('new-row');
            setTimeout(() => row.classList.remove('new-row'), 3000);
        }

        function createRequestRow(request) {
            const row = document.createElement('tr');
            row.id = `request-${request.request_id}`;
            row.className = 'bg-white border-b hover:bg-slate-50';

            // FIX: This logic now handles both old and new data structures gracefully.
            const requestData = typeof request.request_data === 'string' ? JSON.parse(request.request_data) : request.request_data || {};
            
            const bloodType = request.blood_type || requestData.bloodType || 'unknown';
            const patientName = request.patient_name || requestData.patientName || 'N/A';
            const hn = request.hospital_number || requestData.hn || 'No HN';
            const wardName = request.ward_name || requestData.wardName || 'N/A';
            const deliveryLocation = request.delivery_location || requestData.deliveryLocation || 'N/A';
            const deliveryTime = request.delivery_time || requestData.deliveryTime || '';
            const bloodDetails = request.blood_details || `${requestData.subtype || 'N/A'} (${requestData.quantity || '0'} Units)`;

            if (!request.blood_type || request.blood_type.trim() === '') {
                row.classList.add('highlight-blank');
            }

            row.innerHTML = `
                <td class="px-6 py-4 font-bold text-slate-900">
                    <div>${patientName}</div>
                    <div class="font-normal text-slate-500">${hn}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="component-pill component-${bloodType.toLowerCase()}">${bloodType}</div>
                </td>
                <td class="px-6 py-4">
                    <div>${bloodDetails}</div>
                </td>
                <td class="px-6 py-4">${wardName}</td>
                <td class="px-6 py-4">
                    <div>${deliveryLocation}</div>
                    <div class="font-semibold text-sky-700">${deliveryTime}</div>
                </td>
                <td class="px-6 py-4 status-cell">
                    ${createStatusDropdown(request.request_id, request.status)}
                </td>
                <td class="px-6 py-4 requested-at-cell">${formatDateTime(request.created_at)}</td>
                <td class="px-6 py-4 last-update-cell">${formatDateTime(request.updated_at)}</td>
            `;

            row.querySelector('.status-dropdown').addEventListener('change', handleStatusChange);
            return row;
        }

        function createStatusDropdown(requestId, currentStatus) {
            const statuses = ['pending', 'submitted', 'in_progress', 'delivered', 'cancelled'];
            let options = '';
            statuses.forEach(s => {
                const selected = s === currentStatus ? 'selected' : '';
                options += `<option value="${s}" ${selected}>${s.replace('_', ' ')}</option>`;
            });
            return `
                <select data-id="${requestId}" class="status-dropdown status-pill status-${currentStatus} border-none outline-none appearance-none cursor-pointer p-2 pr-8 rounded-full">
                    ${options}
                </select>
            `;
        }

        async function handleStatusChange(event) {
            const selectElement = event.target;
            const requestId = selectElement.dataset.id;
            const newStatus = selectElement.value;

            selectElement.className = `status-dropdown status-pill status-${newStatus} border-none outline-none appearance-none cursor-pointer p-2 pr-8 rounded-full`;

            try {
                const response = await fetch(`${API_BASE_URL}/update_status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId, status: newStatus })
                });
                if (!response.ok) {
                    throw new Error('Failed to update status on the server.');
                }
                console.log(`Successfully sent status update for ${requestId} to ${newStatus}`);
            } catch (error) {
                console.error("Error updating status:", error);
            }
        }

        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                }).replace(',', '');
            } catch (e) {
                return isoString;
            }
        }
    </script>
</body>
</html>

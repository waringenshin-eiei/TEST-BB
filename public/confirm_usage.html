<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î | Blood Request System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sarabun': ['Sarabun', 'system-ui', 'sans-serif'], },
                    colors: {
                        'medical-red': { 50:'#fef7f7', 100:'#fee2e2', 200:'#fecaca', 300:'#fca5a5', 400:'#f87171', 500:'#ef4444', 600:'#dc2626', 700:'#b91c1c', 800:'#991b1b', 900:'#7f1d1d' },
                        'medical-blue': { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        'medical-gold': { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Sarabun', system-ui, sans-serif; background: #f8fafc; min-height: 100vh; }
        .main-container { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(30px); border: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); }
        .form-page { display: none; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .form-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .progress-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-medical { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid #e5e7eb; background: #f9fafb; font-size: 16px; }
        .input-medical:focus { background: #fff; box-shadow: 0 0 0 3px var(--tw-shadow-color); }
        .floating-label input:focus + .label-float, .floating-label input:not(:placeholder-shown) + .label-float { transform: translateY(-1.6rem) scale(0.85); color: var(--tw-label-color); }
        .label-float { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #f9fafb; }
        .floating-label input:focus + .label-float { background: #fff; }
        .theme-red-cells .input-medical:focus { --tw-shadow-color: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .theme-red-cells .floating-label { --tw-label-color: #dc2626; }
        .theme-red-cells .progress-fill, .theme-red-cells .btn-primary { background: linear-gradient(135deg, #f87171, #dc2626); }
        .theme-red-cells .section-header { border-left-color: #ef4444; }
        .theme-plasma .input-medical:focus { --tw-shadow-color: rgba(245, 158, 11, 0.2); border-color: #f59e0b; }
        .theme-plasma .floating-label { --tw-label-color: #d97706; }
        .theme-plasma .progress-fill, .theme-plasma .btn-primary { background: linear-gradient(135deg, #fbbf24, #d97706); }
        .theme-plasma .section-header { border-left-color: #f59e0b; }
        .theme-cryo .input-medical:focus { --tw-shadow-color: rgba(14, 165, 233, 0.2); border-color: #0ea5e9; }
        .theme-cryo .floating-label { --tw-label-color: #0284c7; }
        .theme-cryo .progress-fill, .theme-cryo .btn-primary { background: linear-gradient(135deg, #38bdf8, #0284c7); }
        .theme-cryo .section-header { border-left-color: #0ea5e9; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color); }
        .btn-primary:disabled { background: linear-gradient(135deg, #9ca3af, #6b7280); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #fff; color: #4b5563; border: 2px solid #d1d5db; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; transform: translateY(-2px); }
        .product-card, .selection-card { border-radius: 1.5rem; border: 2px solid #e2e8f0; background: #fff; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; }
        .selection-card { border-radius: 1rem; }
        .product-card:hover, .selection-card:hover { transform: translateY(-5px); border-color: var(--tw-accent-color); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.05); }
        .product-card.selected, .selection-card.selected { border-color: var(--tw-accent-color); transform: translateY(-2px); box-shadow: 0 0 0 4px var(--tw-shadow-color); }
        .theme-red-cells .selection-card.selected { --tw-accent-color: #dc2626; background-color: #fef2f2; }
        .theme-plasma .selection-card.selected { --tw-accent-color: #d97706; background-color: #fffbeb; }
        .theme-cryo .selection-card.selected { --tw-accent-color: #0284c7; background-color: #f0f9ff; }
        .autocomplete-container { position: relative; }
        .autocomplete-items { position: absolute; top: 100%; left: 0; right: 0; z-index: 99; max-height: 240px; overflow-y: auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 1rem 1rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
        .autocomplete-items div { padding: 1rem 1.25rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease; font-weight: 500; }
        .autocomplete-items div:hover { background-color: #f3f4f6; }
        .autocomplete-active { background-color: #f3f4f6 !important; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .summary-docket { background-color: #f8fafc; border: 2px dashed #d1d5db; border-radius: 1.25rem; padding: 1.5rem; margin-top: 2rem; }
        .summary-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1.5rem; }
        .summary-label { font-weight: 600; color: #4b5563; text-align: right; }
        .summary-value { font-weight: 500; color: #111827; }
    </style>
</head>
<body class="py-6 px-3 md:py-8 md:px-4">
    <div class="max-w-4xl mx-auto">
        <div id="mainContainer" class="main-container rounded-3xl p-6 md:p-10 theme-red-cells">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h1>
                <h2 class="text-lg md:text-xl font-medium text-gray-500">Blood Request System</h2>
            </div>
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <p id="stepDescription" class="font-semibold text-gray-700"></p>
                    <span class="text-lg font-bold text-gray-500"><span id="currentStep">1</span> / 4</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="progress-fill h-2.5 rounded-full" style="width: 25%;"></div>
                </div>
            </div>
            <div class="form-page active" id="page1">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h2>
                    <p class="text-gray-600 mt-1">Select Blood Product</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <div class="product-card lg:col-span-2 p-6" data-type="redcell" style="--tw-accent-color: #ef4444; --tw-shadow-color: rgba(239, 68, 68, 0.2);">
                        <h3 class="text-2xl font-bold text-medical-red-600">‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ (Red Blood Cells)</h3>
                        <p class="text-gray-600 mt-2">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô PRC, LPRC, ‡πÅ‡∏•‡∏∞ LDRC</p>
                    </div>
                    <div class="product-card p-6" data-type="ffp" style="--tw-accent-color: #f59e0b; --tw-shadow-color: rgba(245, 158, 11, 0.2);">
                        <h3 class="text-xl font-bold text-medical-gold-600">‡∏û‡∏•‡∏≤‡∏™‡∏°‡∏≤ (Fresh Frozen Plasma)</h3>
                        <p class="text-sm text-gray-500 mt-1">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î</p>
                    </div>
                    <div class="product-card p-6" data-type="cryoprecipitate" style="--tw-accent-color: #0ea5e9; --tw-shadow-color: rgba(14, 165, 233, 0.2);">
                        <h3 class="text-xl font-bold text-medical-blue-600">‡πÑ‡∏Ñ‡∏£‡πÇ‡∏≠‡∏û‡∏£‡∏µ‡∏ã‡∏¥‡∏û‡πÄ‡∏¥‡πÄ‡∏ó‡∏ï (Cryoprecipitate)</h3>
                        <p class="text-sm text-gray-500 mt-1">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏Ç‡∏≠‡∏á FFP</p>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
                </div>
            </div>
            <div class="form-page" id="page2">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</h2>
                    <p class="text-gray-600 mt-1">Patient & Reporter Information</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                    <div class="floating-label mt-6">
                        <input type="text" id="hn" name="hn" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Hospital Number) <span class="text-red-500">*</span></label>
                    </div>
                    <div class="floating-label mt-6">
                        <input type="text" id="patientName" name="patientName" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Patient Name) <span class="text-red-500">*</span></label>
                    </div>
                    <div class="autocomplete-container floating-label mt-6">
                        <input type="text" id="wardName" name="wardName" required class="input-medical w-full h-14 px-4 rounded-xl" autocomplete="off" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Ward) <span class="text-red-500">*</span></label>
                    </div>
                     <div class="floating-label mt-6">
                        <input type="text" id="reporterName" name="reporterName" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Reporter Name) <span class="text-red-500">*</span></label>
                    </div>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage2" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
                </div>
            </div>
            <div class="form-page" id="page3">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>
                    <p class="text-gray-600 mt-1">Product Details</p>
                </div>
                <div id="typeSpecificContent"></div>
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage3" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
                </div>
            </div>
            <div class="form-page" id="page4">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    <p class="text-gray-600 mt-1">Delivery & Summary</p>
                </div>
                <div class="mb-6">
                    <label class="text-lg font-semibold text-gray-700">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (Delivery Time)<span class="text-red-500">*</span></label>
                    <div class="time-cards-grid grid gap-3 mt-3" id="deliveryTimeCards"></div>
                </div>
                <div class="autocomplete-container floating-label mt-6">
                    <input type="text" id="deliveryLocation" name="deliveryLocation" required class="input-medical w-full h-14 px-4 rounded-xl" autocomplete="off" placeholder=" ">
                    <label class="label-float left-4 top-4 text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á (Delivery Location) <span class="text-red-500">*</span></label>
                </div>
                <div class="summary-docket" id="summaryCard"></div>
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                    <button class="btn-primary text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg flex items-center justify-center" id="submitBtn" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="main-container rounded-3xl p-8 text-center max-w-md mx-auto">
            <div id="modalContent"></div>
            <button onclick="closeWindow()" class="btn-secondary font-bold py-3 px-8 rounded-full text-lg w-full mt-6">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (Close)</button>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let selectedBloodType = '';
        let selectedSubtype = ''; 
        let selectedDeliveryTime = { id: null, time: null };
        let lineUserId = '';
        let allWards = [];
        let deliverySchedules = [];
        let formData = {};
        const stepDescriptions = { 1: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå', 2: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 3: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 4: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            lineUserId = urlParams.get('line_user_id');
            if (!lineUserId) {
                showErrorModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (LINE User ID)', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                return;
            }
            fetchInitialData();
            setupEventListeners();
            updatePageUI();
        });

        async function fetchInitialData() {
            try {
                const mockData = {
                    wards: ["2‡∏Å", "2‡∏Ç", "IMC 2‡∏Ñ", "NICU", "2‡∏á", "IMC 2‡∏á", "2‡∏â", "3‡∏Å", "3‡∏Ç", "3‡∏Ñ", "3‡∏á", "3‡∏à", "IMC 3‡∏à", "3‡∏â", "4‡∏Å", "4‡∏Ç1", "4‡∏Ç2", "4‡∏Ç3", "4‡∏Ñ", "4‡∏á", "5‡∏Å", "5‡∏Ç", "5‡∏Ñ", "5‡∏á", "5‡∏à", "6‡∏Å", "6‡∏Ç", "6‡∏à", "OPD AE", "AE1", "AE2", "AE3", "AE4", "SICU1", "SICU2", "SICU3", "NSICU", "Burn Unit", "CCU", "PICU", "MICU 1", "MICU 2", "MICU 3", "CVT-ICU", "SCTU 1", "‡∏´‡∏≠‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò", "8B", "8C", "9A", "9B", "9C", "‡∏™‡∏ß 11", "‡∏™‡∏ß 12", "‡∏™‡∏ß 13", "‡∏™‡∏ß 14", "‡∏™‡∏ß 15", "‡∏Å‡∏ß. 6/1", "‡∏Å‡∏ß. 6/2", "‡∏Å‡∏ß. 7/1", "‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏≠‡∏î", "‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å", "‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", "‡∏´‡πâ‡∏≠‡∏á x-ray", "Endoscope ‡∏™‡∏ß.‡∏ä‡∏±‡πâ‡∏ô4"],
                    schedules: [ { id: 1, time: "10.00‡∏ô." }, { id: 2, time: "11.00‡∏ô." }, { id: 3, time: "12.00‡∏ô." }, { id: 4, time: "13.00‡∏ô." }, { id: 5, time: "14.00‡∏ô." }, { id: 6, time: "15.00‡∏ô." }, { id: 7, time: "16.00‡∏ô." }, { id: 8, time: "18.00‡∏ô." }, { id: 9, time: "20.00‡∏ô." }, { id: 10, time: "21.00‡∏ô." }, { id: 11, time: "23.00‡∏ô." } ]
                };
                allWards = mockData.wards;
                deliverySchedules = mockData.schedules;
                setupAutocomplete(document.getElementById("wardName"), allWards);
                setupAutocomplete(document.getElementById("deliveryLocation"), allWards);
                createDeliveryTimeCards();
            } catch (error) {
                console.error('Error fetching initial data:', error);
                showErrorModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }
        
        const nextPage = () => { if (currentPage < 4) { currentPage++; updatePageUI(); } };
        const previousPage = () => { if (currentPage > 1) { currentPage--; updatePageUI(); } };

        function updatePageUI() {
            document.querySelectorAll('.form-page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page${currentPage}`).classList.add('active');
            document.getElementById('progressBar').style.width = `${(currentPage / 4) * 100}%`;
            document.getElementById('currentStep').textContent = currentPage;
            document.getElementById('stepDescription').textContent = stepDescriptions[currentPage];
            if (currentPage === 3) showTypeSpecificFields();
            if (currentPage === 4) {
                 // Ensure summary is fresh when navigating to page 4
                updateSummary();
                validatePage(4); // Also validate state upon arrival
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.product-card').forEach(card => card.addEventListener('click', handleProductSelection));
            ['nextPage1', 'nextPage2', 'nextPage3'].forEach(id => document.getElementById(id).addEventListener('click', nextPage));
            
            // General validation for page 2 inputs
            ['hn', 'patientName', 'wardName', 'reporterName'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => validatePage(currentPage));
            });
            
            // FIX 1: Refined pre-fill logic for Ward Name
            document.getElementById('wardName').addEventListener('change', e => {
                const deliveryLocationInput = document.getElementById('deliveryLocation');
                // Only pre-fill if delivery location is empty or same as old ward name, allows user override
                if (deliveryLocationInput.value === '' || allWards.includes(deliveryLocationInput.value)) {
                    deliveryLocationInput.value = e.target.value;
                }
                // If we are already on page 4, update the summary immediately
                if (currentPage === 4) {
                    updateSummary();
                    validatePage(4);
                }
            });
            
            // FIX 2: Add a specific listener for Delivery Location to update summary in real-time on page 4
            document.getElementById('deliveryLocation').addEventListener('input', () => {
                if (currentPage === 4) {
                    updateSummary(); // This keeps the visual summary and formData object in sync
                    validatePage(4);
                }
            });

            document.getElementById('submitBtn').addEventListener('click', submitForm);
        }


        function handleProductSelection(event) {
            const card = event.currentTarget;
            selectedBloodType = card.dataset.type;
            const main = document.getElementById('mainContainer');
            main.className = main.className.replace(/theme-\w+/g, '');
            if (selectedBloodType === 'redcell') main.classList.add('theme-red-cells');
            if (selectedBloodType === 'ffp') main.classList.add('theme-plasma');
            if (selectedBloodType === 'cryoprecipitate') main.classList.add('theme-cryo');
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('nextPage1').disabled = false;
        }

        function createDeliveryTimeCards() {
            const container = document.getElementById('deliveryTimeCards');
            container.innerHTML = deliverySchedules.map(({id, time}) => `
                <div class="selection-card text-center p-3 cursor-pointer time-card" data-time-id="${id}" data-time-value="${time}">
                    <div class="text-xl">üïê</div><div class="text-base font-semibold mt-1">${time}</div>
                </div>`).join('');
            container.querySelectorAll('.time-card').forEach(card => card.addEventListener('click', () => {
                container.querySelectorAll('.time-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedDeliveryTime = { id: card.dataset.timeId, time: card.dataset.timeValue };
                if (currentPage === 4) {
                    updateSummary(); // Update summary when time is selected
                    validatePage(4);
                }
            }));
        }

        function showTypeSpecificFields() {
            const container = document.getElementById('typeSpecificContent');
            let content = `<div class="floating-label mt-6"><input type="number" id="quantity" required class="input-medical w-full h-14 px-4 rounded-xl" min="1" max="20" placeholder=" "><label class="label-float left-4 top-4 text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Units)<span class="text-red-500">*</span></label></div>`;
            const subtypes = {
                redcell: [{ key: "PRC", value: "Packed Red Cell" }, { key: "LPRC", value: "Leukocyte Poor" }, { key: "LDRC", value: "Leukocyte Depleted" }],
                ffp: [{ key: "‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ", value: "Ready to Use" }, { key: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á", value: "Frozen Type" }],
                cryoprecipitate: [{ key: "‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ", value: "Ready to Use" }, { key: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á", value: "Frozen Type" }]
            };
            content += `<div class="mt-6"><label class="text-lg font-semibold text-gray-700">‡∏ä‡∏ô‡∏¥‡∏î‡∏¢‡πà‡∏≠‡∏¢ (Subtype)<span class="text-red-500">*</span></label><div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">`;
            subtypes[selectedBloodType].forEach(sub => {
                content += `<div class="selection-card text-center p-4 cursor-pointer subtype-card" data-subtype="${sub.key}"><h4 class="text-lg font-bold">${sub.key}</h4><p class="text-sm text-gray-500">${sub.value}</p></div>`;
            });
            content += `</div></div>`;
            container.innerHTML = content;
            container.querySelectorAll('input, select').forEach(input => input.addEventListener('input', () => validatePage(3)));
            container.querySelectorAll('.subtype-card').forEach(card => card.addEventListener('click', () => {
                container.querySelectorAll('.subtype-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedSubtype = card.dataset.subtype;
                validatePage(3);
            }));
            selectedSubtype = '';
            validatePage(3);
        }

        function updateSummary() {
            // This function now acts as the single source of truth for the final page's data
            formData = {
                hn: document.getElementById('hn').value, patientName: document.getElementById('patientName').value,
                wardName: document.getElementById('wardName').value, bloodType: selectedBloodType,
                quantity: document.getElementById('quantity')?.value, subtype: selectedSubtype,
                deliveryTime: selectedDeliveryTime.time, deliveryLocation: document.getElementById('deliveryLocation').value,
                reporterName: document.getElementById('reporterName').value
            };
            document.getElementById('summaryCard').innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Request Summary)</h3>
                <div class="summary-grid mt-4">
                    <span class="summary-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</span> <span class="summary-value">${formData.patientName || '-'}</span>
                    <span class="summary-label">HN:</span> <span class="summary-value">${formData.hn || '-'}</span>
                    <span class="summary-label">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</span> <span class="summary-value">${formData.wardName || '-'}</span>
                    <span class="summary-label">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:</span> <span class="summary-value font-bold">${(formData.bloodType || '-').toUpperCase()}</span>
                    <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="summary-value">${formData.subtype || '-'} (${formData.quantity || 0} Units)</span>
                    <span class="summary-label">‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á:</span> <span class="summary-value text-blue-600 font-semibold">${formData.deliveryTime || '-'}</span>
                    <span class="summary-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</span> <span class="summary-value">${formData.deliveryLocation || '-'}</span>
                    <span class="summary-label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</span> <span class="summary-value font-semibold">${formData.reporterName || '-'}</span>
                </div>`;
        }

        function validatePage(page) {
            let isValid = false;
            if (page === 2) {
                isValid = document.getElementById('hn').value && document.getElementById('patientName').value && document.getElementById('wardName').value && document.getElementById('reporterName').value;
                document.getElementById('nextPage2').disabled = !isValid;
            } else if (page === 3) {
                isValid = document.getElementById('quantity')?.value > 0 && selectedSubtype;
                document.getElementById('nextPage3').disabled = !isValid;
            } else if (page === 4) {
                isValid = selectedDeliveryTime.id && document.getElementById('deliveryLocation').value;
                document.getElementById('submitBtn').disabled = !isValid;
            }
        }
        
        async function submitForm() {
            // FIX 3: The Failsafe. Call updateSummary() one last time before submission.
            updateSummary();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="loading-spinner"></div> <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...</span>`;
            
            const finalData = { line_user_id: lineUserId, schedule_id: selectedDeliveryTime.id, ...formData };
            
            console.log("Submitting final data:", finalData); // For debugging
            
            try {
                // This is a mock response for demonstration as there's no real backend.
                // In a real scenario, the fetch call would be here.
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                const result = { success: true, request_id: `BR-${Math.floor(Math.random() * 90000) + 10000}` };
                if (!result.success) throw new Error('Mock server error');
                showSuccessModal('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <br><strong class="font-mono text-lg">${result.request_id}</strong>`);
                
                /*
                // REAL FETCH CALL (commented out for demonstration)
                const response = await fetch('/api/submit_request', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Server error');
                showSuccessModal('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <br><strong class="font-mono text-lg">${result.request_id}</strong>`);
                */
            } catch (error) {
                console.error('Submission error:', error);
                showErrorModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
            }
        }

        function showSuccessModal(title, message) {
            document.getElementById('modalContent').innerHTML = `<h2 class="text-2xl font-bold text-green-600">${title}</h2><p class="text-gray-600 mt-4">${message}</p>`;
            document.getElementById('messageModal').classList.remove('hidden');
        }
        function showErrorModal(title, message) {
            document.getElementById('modalContent').innerHTML = `<h2 class="text-2xl font-bold text-red-600">${title}</h2><p class="text-gray-600 mt-4">${message}</p>`;
            document.getElementById('messageModal').classList.remove('hidden');
        }

        // --- REFINED closeWindow function ---
        function closeWindow() {
            // Check if the liff object is available and in use
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.closeWindow();
            } else {
                // Fallback for regular browsers: just hide the modal
                document.getElementById('messageModal').classList.add('hidden');
            }
        }

        // --- Autocomplete Logic (No changes needed here) ---
        function setupAutocomplete(input, suggestions) {
            if (!input || !suggestions) return;
            let currentFocus = -1;
            input.addEventListener("input", function() {
                closeAllLists();
                const val = this.value;
                if (!val) return false;
                currentFocus = -1;
                const listContainer = document.createElement("div");
                listContainer.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listContainer);
                const filtered = suggestions.filter(item => item.toLowerCase().includes(val.toLowerCase())).sort((a,b) => (a.toLowerCase().startsWith(val.toLowerCase()) === b.toLowerCase().startsWith(val.toLowerCase())) ? a.localeCompare(b) : (a.toLowerCase().startsWith(val.toLowerCase()) ? -1 : 1));
                filtered.slice(0, 10).forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.innerHTML = item.replace(new RegExp(`(${val})`, 'gi'), '<strong class="text-medical-red-600 bg-medical-red-100 px-1 rounded">$1</strong>');
                    itemDiv.addEventListener("click", function() {
                        input.value = item;
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                        closeAllLists();
                    });
                    listContainer.appendChild(itemDiv);
                });
            });
            input.addEventListener("keydown", function(e) {
                let items = this.parentNode.querySelector(".autocomplete-items");
                if (items) items = items.getElementsByTagName("div");
                if (e.keyCode === 40) { currentFocus++; addActive(items); } 
                else if (e.keyCode === 38) { currentFocus--; addActive(items); } 
                else if (e.keyCode === 13) { e.preventDefault(); if (currentFocus > -1 && items) items[currentFocus].click(); }
            });
            function addActive(items) {
                if (!items) return false;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(items) {
                for (let i = 0; i < items.length; i++) items[i].classList.remove("autocomplete-active");
            }
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != input) items[i].parentNode.removeChild(items[i]);
                }
            }
            document.addEventListener("click", e => closeAllLists(e.target));
        }
    </script>
</body>
</html>

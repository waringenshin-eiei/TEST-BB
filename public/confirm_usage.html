<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบแจ้งใช้เลือด | Blood Request System</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:Sarabun, system-ui, sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,[type='button'],[type='reset'],[type='submit']{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type='search']{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button, [role="button"]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }.fixed{position:fixed}.absolute{position:absolute}.inset-0{top:0;right:0;bottom:0;left:0}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-2{margin-left:.5rem}.block{display:block}.flex{display:flex}.hidden{display:none}.h-14{height:3.5rem}.h-2\.5{height:.625rem}.w-full{width:100%}.max-w-4xl{max-width:56rem}.max-w-md{max-width:32rem}.flex-1{flex:1 1 0%}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.grid{display:grid}.gap-3{gap:.75rem}.gap-5{gap:1.25rem}.gap-x-6{column-gap:1.5rem}.gap-y-2{row-gap:.5rem}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-full{border-radius:9999px}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-l-4{border-left-width:4px}.border-2{border-width:2px}.border-dashed{border-style:dashed}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity))}.bg-opacity-60{--tw-bg-opacity:0.6}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.pb-3{padding-bottom:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.\!\[-backdrop-blur-sm\]{--tw-backdrop-blur:blur(4px);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur{--tw-backdrop-blur:blur(8px);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.[--tw-accent-color:--tw-accent-color]{--tw-accent-color:var(--tw-accent-color)}@media (min-width:768px){.md\:p-10{padding:2.5rem}.md\:px-4{padding-left:1rem;padding-right:1rem}.md\:py-8{padding-top:2rem;padding-bottom:2rem}.md\:text-5xl{font-size:3rem;line-height:1}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}}@media (min-width:1024px){.lg\:col-span-2{grid-column:span 2 / span 2}.lg\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}
        body { font-family: 'Sarabun', system-ui, sans-serif; background: #f8fafc; min-height: 100vh; }
        .main-container { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(30px); border: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); }
        .form-page { display: none; animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .form-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .progress-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .input-medical { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid #e5e7eb; background: #f9fafb; font-size: 16px; }
        .input-medical:focus { background: #fff; box-shadow: 0 0 0 3px var(--tw-shadow-color); }
        .floating-label input:focus + .label-float, .floating-label input:not(:placeholder-shown) + .label-float, .floating-label textarea:focus + .label-float, .floating-label textarea:not(:placeholder-shown) + .label-float { transform: translateY(-1.6rem) scale(0.85); color: var(--tw-label-color); }
        .label-float { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #f9fafb; }
        .floating-label input:focus + .label-float { background: #fff; }
        .theme-red-cells .input-medical:focus { --tw-shadow-color: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .theme-red-cells .floating-label { --tw-label-color: #dc2626; }
        .theme-red-cells .progress-fill, .theme-red-cells .btn-primary { background: linear-gradient(135deg, #f87171, #dc2626); }
        .theme-red-cells .section-header { border-left-color: #ef4444; }
        .theme-plasma .input-medical:focus { --tw-shadow-color: rgba(245, 158, 11, 0.2); border-color: #f59e0b; }
        .theme-plasma .floating-label { --tw-label-color: #d97706; }
        .theme-plasma .progress-fill, .theme-plasma .btn-primary { background: linear-gradient(135deg, #fbbf24, #d97706); }
        .theme-plasma .section-header { border-left-color: #f59e0b; }
        .theme-cryo .input-medical:focus { --tw-shadow-color: rgba(14, 165, 233, 0.2); border-color: #0ea5e9; }
        .theme-cryo .floating-label { --tw-label-color: #0284c7; }
        .theme-cryo .progress-fill, .theme-cryo .btn-primary { background: linear-gradient(135deg, #38bdf8, #0284c7); }
        .theme-cryo .section-header { border-left-color: #0ea5e9; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color); }
        .btn-primary:disabled { background: linear-gradient(135deg, #9ca3af, #6b7280); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #fff; color: #4b5563; border: 2px solid #d1d5db; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; transform: translateY(-2px); }
        .product-card, .selection-card { border-radius: 1.5rem; border: 2px solid #e2e8f0; background: #fff; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; }
        .selection-card { border-radius: 1rem; }
        .product-card:hover, .selection-card:hover { transform: translateY(-5px); border-color: var(--tw-accent-color); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.05); }
        .product-card.selected, .selection-card.selected { border-color: var(--tw-accent-color); transform: translateY(-2px); box-shadow: 0 0 0 4px var(--tw-shadow-color); }
        .theme-red-cells .selection-card.selected { --tw-accent-color: #dc2626; background-color: #fef2f2; }
        .theme-plasma .selection-card.selected { --tw-accent-color: #d97706; background-color: #fffbeb; }
        .theme-cryo .selection-card.selected { --tw-accent-color: #0284c7; background-color: #f0f9ff; }
        .autocomplete-container { position: relative; }
        .autocomplete-items { position: absolute; top: 100%; left: 0; right: 0; z-index: 99; max-height: 240px; overflow-y: auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 1rem 1rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
        .autocomplete-items div { padding: 1rem 1.25rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease; font-weight: 500; }
        .autocomplete-items div:hover, .autocomplete-active { background-color: #f3f4f6; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .summary-docket { background-color: #f8fafc; border: 2px dashed #d1d5db; border-radius: 1.25rem; padding: 1.5rem; margin-top: 2rem; }
        .summary-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1.5rem; }
        .summary-label { font-weight: 600; color: #4b5563; text-align: right; }
        .summary-value { font-weight: 500; color: #111827; }
        @media (max-width: 768px) {
            .grid-cards { grid-template-columns: 1fr; }
            .time-cards-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
            .summary-row { flex-direction: column; align-items: flex-start; gap: 4px; }
        }
    </style>
</head>
<body class="py-6 px-3 md:py-8 md:px-4">
    <div class="max-w-4xl mx-auto">
        <div id="mainContainer" class="main-container rounded-3xl p-6 md:p-10 theme-red-cells">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-2">ระบบแจ้งใช้เลือด</h1>
                <h2 class="text-lg md:text-xl font-medium text-gray-500">Blood Request System</h2>
            </div>
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <p id="stepDescription" class="font-semibold text-gray-700"></p>
                    <span class="text-lg font-bold text-gray-500">
                        <span id="currentStep">1</span> / 4
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="progress-fill h-2.5 rounded-full" style="width: 25%;"></div>
                </div>
            </div>

            <div class="form-page active" id="page1">
                <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">เลือกผลิตภัณฑ์เลือด</h2>
                    <p class="text-gray-600 mt-1">Select Blood Product</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <div class="product-card lg:col-span-2 p-6" data-type="redcell" style="--tw-accent-color: #ef4444; --tw-shadow-color: rgba(239, 68, 68, 0.2);">
                        <h3 class="text-2xl font-bold text-medical-red-600">เม็ดเลือดแดงชนิดต่างๆ (Red Blood Cells)</h3>
                        <p class="text-gray-600 mt-2">สำหรับผู้ป่วยที่ต้องการเพิ่มความสามารถในการขนส่งออกซิเจน เช่น PRC, LPRC, และ LDRC</p>
                    </div>

                    <div class="product-card p-6" data-type="ffp" style="--tw-accent-color: #f59e0b; --tw-shadow-color: rgba(245, 158, 11, 0.2);">
                        <h3 class="text-xl font-bold text-medical-gold-600">พลาสมา (Fresh Frozen Plasma)</h3>
                        <p class="text-sm text-gray-500 mt-1">สำหรับทดแทนปัจจัยการแข็งตัวของเลือด</p>
                    </div>

                    <div class="product-card p-6" data-type="cryoprecipitate" style="--tw-accent-color: #0ea5e9; --tw-shadow-color: rgba(14, 165, 233, 0.2);">
                        <h3 class="text-xl font-bold text-medical-blue-600">ไครโอพรีซิพเิเทต (Cryoprecipitate)</h3>
                        <p class="text-sm text-gray-500 mt-1">ส่วนประกอบที่เข้มข้นของ FFP</p>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage1" disabled>ถัดไป →</button>
                </div>
            </div>

            <div class="form-page" id="page2">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ข้อมูลผู้ป่วยและผู้แจ้ง</h2>
                    <p class="text-gray-600 mt-1">Patient & Reporter Information</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                    <div class="floating-label mt-6">
                        <input type="text" id="hn" name="hn" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">HN ผู้ป่วย (Hospital Number) <span class="text-red-500">*</span></label>
                    </div>
                    <div class="floating-label mt-6">
                        <input type="text" id="patientName" name="patientName" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">ชื่อผู้ป่วย (Patient Name) <span class="text-red-500">*</span></label>
                    </div>
                    <div class="autocomplete-container floating-label mt-6">
                        <input type="text" id="wardName" name="wardName" required class="input-medical w-full h-14 px-4 rounded-xl" autocomplete="off" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">หอผู้ป่วย (Ward) <span class="text-red-500">*</span></label>
                    </div>
                     <div class="floating-label mt-6">
                        <input type="text" id="reporterName" name="reporterName" required class="input-medical w-full h-14 px-4 rounded-xl" placeholder=" ">
                        <label class="label-float left-4 top-4 text-gray-500">ชื่อผู้แจ้ง (Reporter Name) <span class="text-red-500">*</span></label>
                    </div>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">← ย้อนกลับ</button>
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage2" disabled>ถัดไป →</button>
                </div>
            </div>

            <div class="form-page" id="page3">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">รายละเอียดผลิตภัณฑ์</h2>
                    <p class="text-gray-600 mt-1">Product Details</p>
                </div>
                <div id="typeSpecificContent"></div>
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">← ย้อนกลับ</button>
                    <button class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" id="nextPage3" disabled>ถัดไป →</button>
                </div>
            </div>

            <div class="form-page" id="page4">
                 <div class="section-header border-l-4 p-6 rounded-2xl bg-gray-50 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">การจัดส่งและสรุปข้อมูล</h2>
                    <p class="text-gray-600 mt-1">Delivery & Summary</p>
                </div>
                <div class="mb-6">
                    <label class="text-lg font-semibold text-gray-700">รอบเวลาจัดส่ง (Delivery Time)<span class="text-red-500">*</span></label>
                    <div class="time-cards-grid grid gap-3 mt-3" id="deliveryTimeCards"></div>
                </div>
                <div class="autocomplete-container floating-label mt-6">
                    <input type="text" id="deliveryLocation" name="deliveryLocation" required class="input-medical w-full h-14 px-4 rounded-xl" autocomplete="off" placeholder=" ">
                    <label class="label-float left-4 top-4 text-gray-500">สถานที่ส่ง (Delivery Location) <span class="text-red-500">*</span></label>
                </div>

                <div class="summary-docket" id="summaryCard"></div>
                
                <div class="flex justify-between mt-8">
                    <button class="btn-secondary font-bold py-3 px-8 rounded-full text-lg" onclick="previousPage()">← ย้อนกลับ</button>
                    <button class="btn-primary text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg flex items-center justify-center" id="submitBtn" disabled>ยืนยันและส่งข้อมูล</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="main-container rounded-3xl p-8 text-center max-w-md mx-auto">
            <div id="modalContent"></div>
            <button onclick="closeWindow()" class="btn-secondary font-bold py-3 px-8 rounded-full text-lg w-full mt-6">ปิดหน้าต่าง (Close)</button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let currentPage = 1;
        let selectedBloodType = '';
        let selectedDeliveryTime = { id: null, time: null };
        let lineUserId = '';
        let allWards = [];
        let deliverySchedules = [];
        let formData = {};

        const stepDescriptions = {
            1: 'ขั้นตอนที่ 1: เลือกผลิตภัณฑ์',
            2: 'ขั้นตอนที่ 2: กรอกข้อมูล',
            3: 'ขั้นตอนที่ 3: ระบุรายละเอียด',
            4: 'ขั้นตอนที่ 4: ยืนยันข้อมูล'
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            lineUserId = urlParams.get('line_user_id');
            if (!lineUserId) {
                showErrorModal('ไม่พบข้อมูลผู้ใช้ (LINE User ID)', 'กรุณาเริ่มต้นการแจ้งใช้เลือดจากในแอปพลิเคชัน LINE อีกครั้ง');
                return;
            }
            fetchInitialData();
            setupEventListeners();
            updatePageUI();
        });

        async function fetchInitialData() {
            try {
                // MOCK API: In a real app, this would fetch from your backend.
                // Dynamic detection is removed for speed. The backend only provides lists.
                const mockData = {
                    wards: ["2ก", "2ข", "IMC 2ค", "NICU", "2ง", "IMC 2ง", "2ฉ", "3ก", "3ข", "3ค", "3ง", "3จ", "IMC 3จ", "3ฉ", "4ก", "4ข1", "4ข2", "4ข3", "4ค", "4ง", "5ก", "5ข", "5ค", "5ง", "5จ", "6ก", "6ข", "6จ", "OPD AE", "AE1", "AE2", "AE3", "AE4", "SICU1", "SICU2", "SICU3", "NSICU", "Burn Unit", "CCU", "PICU", "MICU 1", "MICU 2", "MICU 3", "CVT-ICU", "SCTU 1", "หอสงฆ์อาพาธ", "8B", "8C", "9A", "9B", "9C", "สว 11", "สว 12", "สว 13", "สว 14", "สว 15", "กว. 6/1", "กว. 6/2", "กว. 7/1", "ห้องคลอด", "ห้องให้เลือดผู้ป่วยนอก", "ไตเทียม", "ห้อง x-ray", "Endoscope สว.ชั้น4"],
                    schedules: [
                        { id: 1, time: "10.00น." }, { id: 2, time: "11.00น." }, { id: 3, time: "12.00น." },
                        { id: 4, time: "13.00น." }, { id: 5, time: "14.00น." }, { id: 6, time: "15.00น." },
                        { id: 7, time: "16.00น." }, { id: 8, time: "18.00น." }, { id: 9, time: "20.00น." },
                        { id: 10, time: "21.00น." }, { id: 11, time: "23.00น." }
                    ]
                };

                allWards = mockData.wards;
                deliverySchedules = mockData.schedules;
                
                // Fields start blank for manual entry.
                document.getElementById('wardName').value = '';
                document.getElementById('reporterName').value = '';
                document.getElementById('deliveryLocation').value = '';

                setupAutocomplete(document.getElementById("wardName"), allWards);
                setupAutocomplete(document.getElementById("deliveryLocation"), allWards);
                createDeliveryTimeCards();

            } catch (error) {
                console.error('Error fetching initial data:', error);
                showErrorModal('ไม่สามารถโหลดข้อมูลได้', 'กรุณาลองใหม่อีกครั้ง');
            }
        }
        
        // --- UI & Page Navigation ---
        const nextPage = () => { if (currentPage < 4) { currentPage++; updatePageUI(); } };
        const previousPage = () => { if (currentPage > 1) { currentPage--; updatePageUI(); } };

        function updatePageUI() {
            document.querySelectorAll('.form-page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page${currentPage}`).classList.add('active');
            
            document.getElementById('progressBar').style.width = `${(currentPage / 4) * 100}%`;
            document.getElementById('stepDescription').textContent = stepDescriptions[currentPage];
            
            if (currentPage === 3) showTypeSpecificFields();
            if (currentPage === 4) updateSummary();
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.querySelectorAll('.product-card').forEach(card => card.addEventListener('click', handleProductSelection));
            ['nextPage1', 'nextPage2', 'nextPage3'].forEach(id => document.getElementById(id).addEventListener('click', nextPage));
            ['hn', 'patientName', 'wardName', 'reporterName', 'deliveryLocation'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => validatePage(currentPage));
            });
            document.getElementById('wardName').addEventListener('change', e => {
                document.getElementById('deliveryLocation').value = e.target.value;
                validatePage(4);
            });
            document.getElementById('submitBtn').addEventListener('click', submitForm);
        }

        function handleProductSelection(event) {
            const card = event.currentTarget;
            selectedBloodType = card.dataset.type;
            
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.classList.remove('theme-red-cells', 'theme-plasma', 'theme-cryo');
            if (selectedBloodType === 'redcell') mainContainer.classList.add('theme-red-cells');
            if (selectedBloodType === 'ffp') mainContainer.classList.add('theme-plasma');
            if (selectedBloodType === 'cryoprecipitate') mainContainer.classList.add('theme-cryo');

            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('nextPage1').disabled = false;
        }

        // --- Dynamic Content Generation ---
        function createDeliveryTimeCards() {
            const container = document.getElementById('deliveryTimeCards');
            container.innerHTML = deliverySchedules.map(({id, time}) => `
                <div class="selection-card text-center p-3 cursor-pointer time-card" data-time-id="${id}" data-time-value="${time}">
                    <div class="text-xl">🕐</div>
                    <div class="text-base font-semibold mt-1">${time}</div>
                </div>`).join('');

            container.querySelectorAll('.time-card').forEach(card => card.addEventListener('click', () => {
                container.querySelectorAll('.time-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedDeliveryTime = { id: card.dataset.timeId, time: card.dataset.timeValue };
                
                // BUG FIX: Explicitly call updateSummary to ensure instant report refresh
                if (currentPage === 4) {
                    updateSummary();
                }
                validatePage(4);
            }));
        }

        function showTypeSpecificFields() {
            const container = document.getElementById('typeSpecificContent');
            let content = `<div class="floating-label mt-6"><input type="number" id="quantity" required class="input-medical w-full h-14 px-4 rounded-xl" min="1" max="20" placeholder=" "><label class="label-float left-4 top-4 text-gray-500">จำนวน (Units)<span class="text-red-500">*</span></label></div>`;
            
            const subtypes = {
                redcell: [{ key: "PRC", value: "Packed Red Cell" }, { key: "LPRC", value: "Leukocyte Poor" }, { key: "LDRC", value: "Leukocyte Depleted" }],
                ffp: [{ key: "ละลายพร้อมใช้", value: "Ready to Use" }, { key: "ประเภทแช่แข็ง", value: "Frozen Type" }],
                cryoprecipitate: [{ key: "ละลายพร้อมใช้", value: "Ready to Use" }, { key: "ประเภทแช่แข็ง", value: "Frozen Type" }]
            };
            
            content += `<div class="mt-6"><label class="text-lg font-semibold text-gray-700">ชนิดย่อย (Subtype)<span class="text-red-500">*</span></label><div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3" id="subtypeCards">`;
            subtypes[selectedBloodType].forEach(sub => {
                content += `<div class="selection-card text-center p-4 cursor-pointer subtype-card"><h4 class="text-lg font-bold">${sub.key}</h4><p class="text-sm text-gray-500">${sub.value}</p></div>`;
            });
            content += `</div></div><input type="hidden" id="subtype">`;
            container.innerHTML = content;

            container.querySelectorAll('input, select').forEach(input => input.addEventListener('input', () => validatePage(3)));
            container.querySelectorAll('.subtype-card').forEach(card => card.addEventListener('click', () => {
                container.querySelectorAll('.subtype-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                document.getElementById('subtype').value = card.dataset.subtype;
                validatePage(3);
            }));
            validatePage(3);
        }

        function updateSummary() {
            formData = { // Gather all form data
                hn: document.getElementById('hn').value,
                patientName: document.getElementById('patientName').value,
                wardName: document.getElementById('wardName').value,
                bloodType: selectedBloodType,
                quantity: document.getElementById('quantity')?.value,
                subtype: document.getElementById('subtype')?.value,
                deliveryTime: selectedDeliveryTime.time,
                deliveryLocation: document.getElementById('deliveryLocation').value,
                reporterName: document.getElementById('reporterName').value
            };
            
            const summaryContainer = document.getElementById('summaryCard');
            summaryContainer.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">ใบสรุปคำขอ (Request Summary)</h3>
                <div class="summary-grid mt-4">
                    <span class="summary-label">ผู้ป่วย:</span> <span class="summary-value">${formData.patientName || '-'}</span>
                    <span class="summary-label">HN:</span> <span class="summary-value">${formData.hn || '-'}</span>
                    <span class="summary-label">หอผู้ป่วย:</span> <span class="summary-value">${formData.wardName || '-'}</span>
                    <span class="summary-label">ผลิตภัณฑ์:</span> <span class="summary-value font-bold">${(formData.bloodType || '-').toUpperCase()}</span>
                    <span class="summary-label">รายละเอียด:</span> <span class="summary-value">${formData.subtype || '-'} (${formData.quantity || 0} Units)</span>
                    <span class="summary-label">รอบส่ง:</span> <span class="summary-value text-blue-600 font-semibold">${formData.deliveryTime || '-'}</span>
                    <span class="summary-label">สถานที่:</span> <span class="summary-value">${formData.deliveryLocation || '-'}</span>
                    <span class="summary-label">ผู้แจ้ง:</span> <span class="summary-value font-semibold">${formData.reporterName || '-'}</span>
                </div>`;
        }

        // --- Validation ---
        function validatePage(page) {
            let isValid = false;
            if (page === 2) {
                isValid = document.getElementById('hn').value && document.getElementById('patientName').value && document.getElementById('wardName').value && document.getElementById('reporterName').value;
                document.getElementById('nextPage2').disabled = !isValid;
            } else if (page === 3) {
                isValid = document.getElementById('quantity')?.value > 0 && document.getElementById('subtype')?.value;
                document.getElementById('nextPage3').disabled = !isValid;
            } else if (page === 4) {
                isValid = selectedDeliveryTime.id && document.getElementById('deliveryLocation').value;
                document.getElementById('submitBtn').disabled = !isValid;
            }
        }
        
        // --- Form Submission ---
        async function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="loading-spinner"></div> <span>กำลังส่ง...</span>`;
            
            const finalData = {
                line_user_id: lineUserId,
                schedule_id: selectedDeliveryTime.id,
                ...formData
            };
            
            try {
                const response = await fetch('/api/submit_request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalData)
                });
                const result = await response.json();

                if (!response.ok) throw new Error(result.message || 'Server error');
                
                showSuccessModal('ส่งข้อมูลสำเร็จแล้ว', `หมายเลขคำขอของคุณคือ: <br><strong class="font-mono text-lg">${result.request_id}</strong>`);

            } catch (error) {
                console.error('Submission error:', error);
                showErrorModal('เกิดข้อผิดพลาดในการส่งข้อมูล', error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = `ยืนยันและส่งข้อมูล`;
            }
        }
        
        // --- Modals & Utils ---
        function showSuccessModal(title, message) {
            document.getElementById('modalContent').innerHTML = `<h2 class="text-2xl font-bold text-green-600">${title}</h2><p class="text-gray-600 mt-4">${message}</p>`;
            document.getElementById('messageModal').classList.remove('hidden');
        }
        function showErrorModal(title, message) {
            document.getElementById('modalContent').innerHTML = `<h2 class="text-2xl font-bold text-red-600">${title}</h2><p class="text-gray-600 mt-4">${message}</p>`;
            document.getElementById('messageModal').classList.remove('hidden');
        }
        function closeWindow() {
            document.getElementById('modalContent').innerHTML = `<p>คุณสามารถปิดหน้าต่างนี้ได้</p>`;
            document.querySelector('#messageModal button').style.display = 'none';
        }

        // --- Autocomplete Logic ---
        function setupAutocomplete(input, suggestions) {
            if (!input || !suggestions) return;
            let currentFocus = -1;
            input.addEventListener("input", function() {
                closeAllLists();
                const val = this.value;
                if (!val) return false;
                currentFocus = -1;
                const listContainer = document.createElement("div");
                listContainer.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listContainer);
                const filteredSuggestions = suggestions.filter(item => item.toLowerCase().includes(val.toLowerCase())).sort((a,b) => (a.toLowerCase().startsWith(val.toLowerCase()) === b.toLowerCase().startsWith(val.toLowerCase())) ? a.localeCompare(b) : (a.toLowerCase().startsWith(val.toLowerCase()) ? -1 : 1));
                filteredSuggestions.slice(0, 10).forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.innerHTML = item.replace(new RegExp(`(${val})`, 'gi'), '<strong class="text-medical-red-600 bg-medical-red-100 px-1 rounded">$1</strong>');
                    itemDiv.addEventListener("click", function() {
                        input.value = item;
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                        closeAllLists();
                    });
                    listContainer.appendChild(itemDiv);
                });
            });
            input.addEventListener("keydown", function(e) {
                let items = this.parentNode.querySelector(".autocomplete-items");
                if (items) items = items.getElementsByTagName("div");
                if (e.keyCode === 40) { currentFocus++; addActive(items); } 
                else if (e.keyCode === 38) { currentFocus--; addActive(items); } 
                else if (e.keyCode === 13) { e.preventDefault(); if (currentFocus > -1 && items) items[currentFocus].click(); }
            });
            function addActive(items) {
                if (!items) return false;
                removeActive(items);
if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(items) {
                for (let i = 0; i < items.length; i++) items[i].classList.remove("autocomplete-active");
            }
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != input) items[i].parentNode.removeChild(items[i]);
                }
            }
            document.addEventListener("click", e => closeAllLists(e.target));
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î | Blood Usage Confirmation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        'sarabun': ['Sarabun', 'system-ui', 'sans-serif'],
                        'inter': ['Inter', 'system-ui', 'sans-serif']
                    },
                    colors: { 
                        'medical': { 
                            50:'#fef7f7', 100:'#fee2e2', 200:'#fecaca', 300:'#fca5a5', 
                            400:'#f87171', 500:'#ef4444', 600:'#dc2626', 700:'#b91c1c', 
                            800:'#991b1b', 900:'#7f1d1d' 
                        },
                        'healthcare': {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
                            400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                            800: '#075985', 900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Sarabun', 'Inter', system-ui, sans-serif; 
            background: linear-gradient(135deg, #fef7f7 0%, #fee2e2 25%, #fecaca 50%, #f0f9ff 75%, #e0f2fe 100%);
            min-height: 100vh;
        }
        
        .medical-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(239, 68, 68, 0.1);
            box-shadow: 0 20px 60px rgba(239, 68, 68, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .selection-card {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .selection-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .selection-card:hover::before {
            left: 100%;
        }
        
        .selection-card:hover {
            border-color: #ef4444;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.2);
        }
        
        .selection-card.selected {
            border-color: #ef4444;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(239, 68, 68, 0.4);
        }
        
        .selection-card.selected .card-icon {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            display: block;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .card-subtitle {
            font-size: 0.95rem;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .input-medical {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.95);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .input-medical:focus {
            background: #fff;
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-medical-primary {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-medical-primary:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(239, 68, 68, 0.4);
        }
        
        .btn-medical-primary:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-medical-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-medical-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
        }
        
        .medical-header-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.3);
            animation: pulse 3s infinite;
        }
        
        .progress-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            background: #e5e7eb;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .form-page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(14, 165, 233, 0.05));
            border-left: 6px solid #ef4444;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .bilingual-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .label-thai {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            font-family: 'Sarabun', sans-serif;
        }
        
        .label-english {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            font-family: 'Inter', sans-serif;
        }
        
        .required-mark {
            color: #ef4444;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 28px;
            margin: 28px 0;
            position: relative;
        }
        
        .summary-card::before {
            content: 'üìã';
            position: absolute;
            top: -15px;
            left: 20px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .summary-row:hover {
            background: rgba(239, 68, 68, 0.02);
            border-radius: 8px;
            padding-left: 12px;
            padding-right: 12px;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .floating-label {
            position: relative;
            margin-bottom: 24px;
        }
        
        .floating-label input:focus + .label-float,
        .floating-label input:not(:placeholder-shown) + .label-float,
        .floating-label textarea:focus + .label-float,
        .floating-label textarea:not(:placeholder-shown) + .label-float {
            transform: translateY(-28px) scale(0.85);
            color: #ef4444;
        }
        
        .label-float {
            position: absolute;
            left: 16px;
            top: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            background: white;
            padding: 0 8px;
            font-weight: 500;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
            max-height: 240px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-items div {
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .autocomplete-items div:hover {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
            transform: translateX(4px);
        }
        
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .time-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 16px 8px;
            }
            
            .max-w-6xl {
                max-width: 100%;
                padding: 0 8px;
            }
            
            .medical-card {
                padding: 24px 16px;
                border-radius: 20px;
            }
            
            .grid-cards {
                grid-template-columns: 1fr;
                gap: 16px;
                margin: 20px 0;
            }
            
            .time-cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .selection-card {
                padding: 20px 16px;
                border-radius: 12px;
            }
            
            .card-icon {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .card-title {
                font-size: 1.1rem;
                margin-bottom: 6px;
            }
            
            .card-subtitle {
                font-size: 0.85rem;
            }
            
            .medical-header-icon {
                width: 70px;
                height: 70px;
                margin-bottom: 16px;
            }
            
            .text-6xl {
                font-size: 2.5rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
            
            .text-3xl {
                font-size: 1.75rem;
            }
            
            .section-header {
                padding: 16px;
                margin-bottom: 20px;
            }
            
            .input-medical {
                height: 56px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
            }
            
            .floating-label {
                margin-bottom: 20px;
            }
            
            .label-float {
                font-size: 14px;
                top: 16px;
                left: 12px;
            }
            
            .floating-label input:focus + .label-float,
            .floating-label input:not(:placeholder-shown) + .label-float,
            .floating-label textarea:focus + .label-float,
            .floating-label textarea:not(:placeholder-shown) + .label-float {
                transform: translateY(-24px) scale(0.85);
            }
            
            .btn-medical-primary,
            .btn-medical-secondary {
                padding: 16px 24px;
                font-size: 16px;
                border-radius: 12px;
                min-height: 48px; /* Better touch target */
            }
            
            .flex.justify-between {
                flex-direction: column;
                gap: 12px;
            }
            
            .flex.justify-between button {
                width: 100%;
            }
            
            .progress-container {
                padding: 16px;
                margin-bottom: 20px;
                border-radius: 12px;
            }
            
            .summary-card {
                padding: 20px 16px;
                margin: 20px 0;
                border-radius: 16px;
            }
            
            .summary-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 0;
            }
            
            .bilingual-label {
                margin-bottom: 8px;
            }
            
            .label-thai {
                font-size: 1rem;
            }
            
            .label-english {
                font-size: 0.8rem;
            }
            
            .autocomplete-items {
                max-height: 200px;
                border-radius: 0 0 12px 12px;
            }
            
            .autocomplete-items div {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            /* Mobile-specific touch improvements */
            .selection-card {
                min-height: 80px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
            }
            
            .time-card {
                min-height: 70px;
                padding: 12px 8px;
            }
            
            .time-card .card-icon {
                font-size: 1.5rem;
                margin-bottom: 4px;
            }
            
            .time-card .card-title {
                font-size: 0.9rem;
            }
            
            /* Improve modal on mobile */
            .modal-backdrop .medical-card {
                margin: 16px;
                max-width: calc(100vw - 32px);
                padding: 24px 20px;
            }
            
            /* Better spacing for mobile form */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .grid.grid-cols-2.md\\:grid-cols-4.lg\\:grid-cols-6 {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            /* Mobile keyboard optimization */
            .autocomplete-container {
                position: relative;
                z-index: 10;
            }
        }
        
        @media (max-width: 480px) {
            .medical-card {
                padding: 20px 12px;
                border-radius: 16px;
            }
            
            .time-cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .time-card {
                min-height: 60px;
                padding: 8px 6px;
            }
            
            .time-card .card-title {
                font-size: 0.8rem;
            }
            
            .text-6xl {
                font-size: 2rem;
            }
            
            .input-medical {
                height: 52px;
                padding: 0 12px;
            }
            
            .floating-label textarea.input-medical {
                height: 100px;
                padding: 12px;
            }
        }
    </style>
</head>
<body class="py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <input type="hidden" id="requestId" name="requestId">
        
        <!-- Header Section -->
        <div class="text-center mb-12">
            <div class="medical-header-icon">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-4v-4H6v-4h4V5h4v4h4v4h-4v4z"/>
                </svg>
            </div>
            <h1 class="text-6xl font-bold text-gray-800 mb-4 font-sarabun">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h1>
            <h2 class="text-2xl font-medium text-gray-600 mb-6 font-inter">Blood Usage Confirmation System</h2>
            <p id="requestIdDisplay" class="text-xl text-gray-700 font-mono bg-white bg-opacity-80 rounded-full px-6 py-3 inline-block shadow-lg"></p>
        </div>

        <!-- Main Form Container -->
        <div class="medical-card rounded-3xl p-10">
            <!-- Progress Section -->
            <div class="progress-container">
                <div class="flex justify-between items-center mb-4">
                    <div class="bilingual-label">
                        <span class="label-thai">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                        <span class="label-english">Progress</span>
                    </div>
                    <span class="text-xl font-bold text-medical-600">
                        <span id="currentStep">1</span><span class="text-gray-400">/4</span>
                    </span>
                </div>
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill" style="width: 25%;"></div>
                </div>
                <div class="text-sm text-gray-600 mt-3">
                    <span class="font-sarabun">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà </span>
                    <span id="stepDescription" class="font-inter">Blood Type Selection</span>
                </div>
            </div>

            <!-- Page 1: Blood Type Selection -->
            <div class="form-page active" id="page1">
                <div class="section-header">
                    <div class="bilingual-label">
                        <h2 class="label-thai text-3xl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h2>
                        <p class="label-english text-lg">Select Blood Product Type</p>
                    </div>
                    <p class="text-gray-600 mt-4 font-sarabun">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                </div>
                
                <div class="grid-cards" id="bloodTypeSelector">
                    <div class="selection-card" data-type="ffp">
                        <div class="card-title font-inter text-lg">Fresh Frozen Plasma</div>
                        <div class="card-subtitle font-inter">FFP</div>
                    </div>
                    
                    <div class="selection-card" data-type="redcell">
                        <div class="card-title font-inter text-lg">Red Blood Cells</div>
                        <div class="card-subtitle font-sarabun">PRC, LPRC, LDRC</div>
                    </div>
                    
                    <div class="selection-card" data-type="cryoprecipitate">
                        <div class="card-title font-inter text-lg">Cryoprecipitate</div>
                        <div class="card-subtitle font-inter">Clotting factors</div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button class="btn-medical-primary px-10 py-4 rounded-2xl font-medium text-white text-xl" id="nextPage1" disabled>
                        <span class="font-sarabun mr-2">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                        <span class="font-inter">Next</span>
                        <svg class="inline ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Page 2: Patient Information -->
            <div class="form-page" id="page2">
                <div class="section-header">
                    <div class="bilingual-label">
                        <h2 class="label-thai text-3xl">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                        <p class="label-english text-lg">Patient Information</p>
                    </div>
                    <p class="text-gray-600 mt-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="floating-label">
                        <input type="text" id="hn" name="hn" required class="input-medical w-full h-16 px-6 rounded-2xl" placeholder=" ">
                        <label class="label-float">
                            <span class="font-sarabun">HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                            <span class="font-inter text-sm"> | Hospital Number</span>
                            <span class="required-mark">*</span>
                        </label>
                    </div>
                    
                    <div class="floating-label">
                        <input type="text" id="patientName" name="patientName" required class="input-medical w-full h-16 px-6 rounded-2xl" placeholder=" ">
                        <label class="label-float">
                            <span class="font-sarabun">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                            <span class="font-inter text-sm"> | Patient Name</span>
                            <span class="required-mark">*</span>
                        </label>
                    </div>
                </div>

                <div class="autocomplete-container mb-8">
                    <div class="floating-label">
                        <input type="text" id="wardName" name="wardName" required class="input-medical w-full h-16 px-6 rounded-2xl" autocomplete="off" placeholder=" ">
                        <label class="label-float">
                            <span class="font-sarabun">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                            <span class="font-inter text-sm"> | Ward</span>
                            <span class="required-mark">*</span>
                        </label>
                    </div>
                </div>

                <div class="floating-label">
                    <textarea id="bloodDetails" name="bloodDetails" class="input-medical w-full h-32 px-6 py-4 rounded-2xl resize-none" placeholder=" "></textarea>
                    <label class="label-float">
                        <span class="font-sarabun">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                        <span class="font-inter text-sm"> | Additional Details</span>
                    </label>
                </div>

                <div class="flex justify-between mt-10">
                    <button class="btn-medical-secondary px-10 py-4 rounded-2xl font-medium text-xl" onclick="previousPage()">
                        <svg class="inline mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="font-sarabun">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
                    </button>
                    <button class="btn-medical-primary px-10 py-4 rounded-2xl font-medium text-white text-xl" id="nextPage2" disabled>
                        <span class="font-sarabun mr-2">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                        <span class="font-inter">Next</span>
                        <svg class="inline ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Page 3: Type-specific Details -->
            <div class="form-page" id="page3">
                <div class="section-header">
                    <div class="bilingual-label">
                        <h2 class="label-thai text-3xl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h2>
                        <p class="label-english text-lg">Product-Specific Details</p>
                    </div>
                    <p class="text-gray-600 mt-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏î</p>
                </div>
                
                <div id="typeSpecificContent">
                    <!-- Content will be dynamically inserted -->
                </div>

                <div class="flex justify-between mt-10">
                    <button class="btn-medical-secondary px-10 py-4 rounded-2xl font-medium text-xl" onclick="previousPage()">
                        <svg class="inline mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="font-sarabun">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
                    </button>
                    <button class="btn-medical-primary px-10 py-4 rounded-2xl font-medium text-white text-xl" id="nextPage3" disabled>
                        <span class="font-sarabun mr-2">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                        <span class="font-inter">Next</span>
                        <svg class="inline ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Page 4: Delivery & Confirmation -->
            <div class="form-page" id="page4">
                <div class="section-header">
                    <div class="bilingual-label">
                        <h2 class="label-thai text-3xl">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h2>
                        <p class="label-english text-lg">Delivery & Confirmation</p>
                    </div>
                    <p class="text-gray-600 mt-4">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                
                <!-- Delivery Time Cards -->
                <div class="mb-8">
                    <div class="bilingual-label">
                        <span class="label-thai text-xl">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>
                        <span class="label-english">Delivery Schedule</span>
                        <span class="required-mark">*</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-4 time-cards-grid" id="deliveryTimeCards">
                        <!-- Time cards will be inserted here -->
                    </div>
                </div>

                <!-- Delivery Location -->
                <div class="autocomplete-container mb-8">
                    <div class="floating-label">
                        <input type="text" id="deliveryLocation" name="deliveryLocation" required class="input-medical w-full h-16 px-6 rounded-2xl" autocomplete="off" placeholder=" ">
                        <label class="label-float">
                            <span class="font-sarabun">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î</span>
                            <span class="font-inter text-sm"> | Delivery Location</span>
                            <span class="required-mark">*</span>
                        </label>
                    </div>
                </div>

                <!-- Reporter Name -->
                <div class="floating-label mb-8">
                    <input type="text" id="reporterName" name="reporterName" required class="input-medical w-full h-16 px-6 rounded-2xl" placeholder=" ">
                    <label class="label-float">
                        <span class="font-sarabun">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span>
                        <span class="font-inter text-sm"> | Reporter Name</span>
                        <span class="required-mark">*</span>
                    </label>
                </div>

                <!-- Summary Card -->
                <div class="summary-card">
                    <div class="bilingual-label mb-6">
                        <h3 class="label-thai text-2xl">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h3>
                        <p class="label-english">Blood Usage Summary</p>
                    </div>
                    <div id="summaryContent">
                        <!-- Summary content will be inserted here -->
                    </div>
                </div>

                <div class="flex justify-between mt-10">
                    <button class="btn-medical-secondary px-10 py-4 rounded-2xl font-medium text-xl" onclick="previousPage()">
                        <svg class="inline mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="font-sarabun">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
                    </button>
                    <button class="btn-medical-primary px-12 py-4 rounded-2xl font-medium text-white text-xl" id="submitBtn" disabled>
                        <svg class="inline mr-3 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="font-sarabun">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span class="font-inter ml-2">Submit</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Modal -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="medical-card p-12 rounded-3xl text-center max-w-lg mx-4">
            <div id="modalIcon" class="w-24 h-24 mx-auto mb-8 rounded-full flex items-center justify-center"></div>
            <div id="modalText" class="text-xl font-medium text-gray-800 mb-10"></div>
            <button onclick="closeWindow()" class="btn-medical-secondary px-10 py-4 rounded-2xl font-medium w-full text-xl">
                <span class="font-sarabun">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</span>
                <span class="font-inter ml-2">Close</span>
            </button>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let selectedBloodType = '';
        let selectedDeliveryTime = '';
        let requestId = '';
        let allWards = [];
        let deliverySchedules = [];

        const stepDescriptions = {
            1: 'Blood Type Selection | ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏•‡∏∑‡∏≠‡∏î',
            2: 'Patient Information | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', 
            3: 'Product Details | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå',
            4: 'Delivery & Confirmation | ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            requestId = urlParams.get('request_id');
            
            if (!requestId) {
                showErrorModal('‡πÑ‡∏°‡πà‡∏û‡∏ö Request ID<br><small class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small>');
                return;
            }
            
            document.getElementById('requestId').value = requestId;
            document.getElementById('requestIdDisplay').innerHTML = `
                <span class="font-sarabun">Request ID:</span> 
                <span class="font-mono font-bold text-medical-600">${requestId}</span>
            `;
            
            fetchFormData();
            setupEventListeners();
            updatePageUI();
        });

        async function fetchFormData() {
            try {
                // Fetch wards data with better error handling
                try {
                    const wardsRes = await fetch('/api/ward_validation?action=list');
                    if (wardsRes.ok) {
                        const wardsData = await wardsRes.json();
                        allWards = wardsData.wards.map(ward => ward.ward_name);
                    } else {
                        throw new Error('Ward API not available');
                    }
                } catch (wardError) {
                    console.warn('Using fallback ward data:', wardError);
                    // Fallback ward data
                    allWards = [
                        "2‡∏Å", "2‡∏Ç", "IMC 2‡∏Ñ", "NICU", "2‡∏á", "IMC 2‡∏á", "2‡∏â", "3‡∏Å", "3‡∏Ç", "3‡∏Ñ", "3‡∏á", "3‡∏à", 
                        "IMC 3‡∏à", "3‡∏â", "4‡∏Å", "4‡∏Ç1", "4‡∏Ç2", "4‡∏Ç3", "4‡∏Ñ", "4‡∏á", "5‡∏Å", "5‡∏Ç", "5‡∏Ñ", "5‡∏á", "5‡∏à", 
                        "6‡∏Å", "6‡∏Ç", "6‡∏à", "OPD AE", "AE1", "AE2", "AE3", "AE4", "SICU1", "SICU2", "SICU3", 
                        "NSICU", "Burn Unit", "CCU", "PICU", "MICU 1", "MICU 2", "MICU 3", "CVT-ICU", "SCTU 1", 
                        "‡∏´‡∏≠‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò", "8B", "8C", "9A", "9B", "9C", "‡∏™‡∏ß 11", "‡∏™‡∏ß 12", "‡∏™‡∏ß 13", "‡∏™‡∏ß 14", "‡∏™‡∏ß 15", 
                        "‡∏Å‡∏ß. 6/1", "‡∏Å‡∏ß. 6/2", "‡∏Å‡∏ß. 7/1", "‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏≠‡∏î", "‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å", "‡πÑ‡∏ï‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", 
                        "‡∏´‡πâ‡∏≠‡∏á x-ray", "Endoscope ‡∏™‡∏ß.‡∏ä‡∏±‡πâ‡∏ô4"
                    ];
                }

                // Setup autocomplete for both ward fields
                setupAutocomplete(document.getElementById("wardName"), allWards);
                setupAutocomplete(document.getElementById("deliveryLocation"), allWards);

                // Fetch delivery schedules
                try {
                    const schedulesRes = await fetch('/api/ward_validation?action=list_schedules');
                    if (schedulesRes.ok) {
                        const schedulesData = await schedulesRes.json();
                        deliverySchedules = schedulesData.schedules || [
                            "10.00‡∏ô.", "11.00‡∏ô.", "12.00‡∏ô.", "13.00‡∏ô.", "14.00‡∏ô.", 
                            "15.00‡∏ô.", "16.00‡∏ô.", "18.00‡∏ô.", "20.00‡∏ô.", "21.00‡∏ô", "23.00‡∏ô."
                        ];
                    } else {
                        throw new Error('Schedule API not available');
                    }
                } catch (scheduleError) {
                    console.warn('Using fallback schedule data:', scheduleError);
                    deliverySchedules = [
                        "10.00‡∏ô.", "11.00‡∏ô.", "12.00‡∏ô.", "13.00‡∏ô.", "14.00‡∏ô.", 
                        "15.00‡∏ô.", "16.00‡∏ô.", "18.00‡∏ô.", "20.00‡∏ô.", "21.00‡∏ô", "23.00‡∏ô."
                    ];
                }

                createDeliveryTimeCards();

            } catch (error) {
                console.error('Error fetching form data:', error);
                // Use complete fallback data
                allWards = ["2‡∏Å", "2‡∏Ç", "3‡∏Å", "3‡∏Ç", "4‡∏Å", "4‡∏Ç", "ICU", "NICU"];
                deliverySchedules = ["10.00‡∏ô.", "11.00‡∏ô.", "12.00‡∏ô.", "13.00‡∏ô.", "14.00‡∏ô.", "15.00‡∏ô."];
                
                setupAutocomplete(document.getElementById("wardName"), allWards);
                setupAutocomplete(document.getElementById("deliveryLocation"), allWards);
                createDeliveryTimeCards();
            }
        }

        function createDeliveryTimeCards() {
            const container = document.getElementById('deliveryTimeCards');
            container.innerHTML = deliverySchedules.map(time => `
                <div class="selection-card text-center py-4 px-3 cursor-pointer time-card" data-time="${time}">
                    <div class="card-icon text-2xl">üïê</div>
                    <div class="card-title text-lg font-sarabun">${time}</div>
                </div>
            `).join('');

            // Add click handlers for time cards
            container.querySelectorAll('.time-card').forEach(card => {
                card.addEventListener('click', () => {
                    container.querySelectorAll('.time-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedDeliveryTime = card.dataset.time;
                    validatePage4();
                });
            });
        }

        function setupEventListeners() {
            // Blood type selection
            document.querySelectorAll('[data-type]').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('[data-type]').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedBloodType = card.dataset.type;
                    document.getElementById('nextPage1').disabled = false;
                });
            });
            
            // Next button listeners
            ['nextPage1', 'nextPage2', 'nextPage3'].forEach(id => {
                document.getElementById(id).addEventListener('click', nextPage);
            });
            
            // Form validation listeners
            ['hn', 'patientName', 'wardName'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validatePage2);
                    element.addEventListener('change', validatePage2);
                }
            });
            
            ['deliveryLocation', 'reporterName'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validatePage4);
                    element.addEventListener('change', validatePage4);
                }
            });
            
            // Auto-fill delivery location from ward
            document.getElementById('wardName').addEventListener('change', e => {
                document.getElementById('deliveryLocation').value = e.target.value;
                validatePage4();
            });

            // Submit button
            document.getElementById('submitBtn').addEventListener('click', submitForm);
        }
        
        const nextPage = () => { 
            console.log('Next page clicked, current page:', currentPage);
            if (currentPage < 4) {
                currentPage++; 
                console.log('Moving to page:', currentPage);
                updatePageUI(); 
            }
        };
        
        const previousPage = () => { 
            console.log('Previous page clicked, current page:', currentPage);
            if (currentPage > 1) {
                currentPage--; 
                console.log('Moving to page:', currentPage);
                updatePageUI(); 
            }
        };

        function updatePageUI() {
            console.log('Updating UI for page:', currentPage);
            
            // Update page visibility
            document.querySelectorAll('.form-page').forEach((page, index) => {
                page.classList.remove('active');
                console.log(`Page ${index + 1} hidden`);
            });
            
            const currentPageElement = document.getElementById(`page${currentPage}`);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
                console.log(`Page ${currentPage} shown`);
            }
            
            // Update progress bar
            const progress = (currentPage / 4) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Update step counter and description
            document.getElementById('currentStep').textContent = currentPage;
            document.getElementById('stepDescription').textContent = stepDescriptions[currentPage];
            
            // Handle page-specific logic
            if (currentPage === 3) {
                console.log('Showing type specific fields for:', selectedBloodType);
                showTypeSpecificFields();
            }
            if (currentPage === 4) {
                console.log('Updating summary for page 4');
                updateSummary();
            }
        }

        function validatePage2() {
            const hn = document.getElementById('hn')?.value?.trim() || '';
            const patientName = document.getElementById('patientName')?.value?.trim() || '';
            const wardName = document.getElementById('wardName')?.value?.trim() || '';
            
            const isValid = hn && patientName && wardName;
            const nextBtn = document.getElementById('nextPage2');
            if (nextBtn) {
                nextBtn.disabled = !isValid;
            }
            
            console.log('Page 2 validation:', { hn, patientName, wardName, isValid });
        }

        function validatePage3() {
            const quantity = document.getElementById('quantity')?.value;
            const subtype = document.getElementById('subtype')?.value;
            const isValid = quantity && subtype && parseInt(quantity) > 0;
            const nextBtn = document.getElementById('nextPage3');
            if (nextBtn) {
                nextBtn.disabled = !isValid;
            }
            
            console.log('Page 3 validation:', { quantity, subtype, isValid });
        }

        function validatePage4() {
            const deliveryLocation = document.getElementById('deliveryLocation')?.value?.trim() || '';
            const reporterName = document.getElementById('reporterName')?.value?.trim() || '';
            
            const isValid = selectedDeliveryTime && deliveryLocation && reporterName;
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = !isValid;
            }
            
            if (currentPage === 4) updateSummary();
            
            console.log('Page 4 validation:', { selectedDeliveryTime, deliveryLocation, reporterName, isValid });
        }
        
        function showTypeSpecificFields() {
            const container = document.getElementById('typeSpecificContent');
            
            // Quantity field (common for all types)
            let content = `
                <div class="floating-label mb-8">
                    <input type="number" id="quantity" class="input-medical w-full h-16 px-6 rounded-2xl" min="1" max="20" placeholder=" ">
                    <label class="label-float">
                        <span class="font-sarabun">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                        <span class="font-inter text-sm"> | Quantity (Units)</span>
                        <span class="required-mark">*</span>
                    </label>
                </div>
            `;

            // Type-specific fields
            if (selectedBloodType === 'redcell') {
                content += `
                    <div class="mb-8">
                        <div class="bilingual-label">
                            <span class="label-thai text-xl">‡∏ä‡∏ô‡∏¥‡∏î Red Blood Cells</span>
                            <span class="label-english">Red Cell Type</span>
                            <span class="required-mark">*</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" id="subtypeCards">
                            <div class="selection-card text-center py-6 cursor-pointer subtype-card" data-subtype="Packed red cell (PRC)">
                                <div class="card-icon text-3xl">üî¥</div>
                                <div class="card-title font-sarabun">PRC</div>
                                <div class="card-subtitle font-inter">Packed Red Cell</div>
                            </div>
                            <div class="selection-card text-center py-6 cursor-pointer subtype-card" data-subtype="Leukocyte poor red cell (LPRC)">
                                <div class="card-icon text-3xl">ü©∏</div>
                                <div class="card-title font-sarabun">LPRC</div>
                                <div class="card-subtitle font-inter">Leukocyte Poor</div>
                            </div>
                            <div class="selection-card text-center py-6 cursor-pointer subtype-card" data-subtype="Leukocyte depleted red cell (LDRC)">
                                <div class="card-icon text-3xl">‚≠ï</div>
                                <div class="card-title font-sarabun">LDRC</div>
                                <div class="card-subtitle font-inter">Leukocyte Depleted</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // FFP or Cryoprecipitate
                const productName = selectedBloodType === 'ffp' ? 'FFP' : 'Cryoprecipitate';
                content += `
                    <div class="mb-8">
                        <div class="bilingual-label">
                            <span class="label-thai text-xl">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${productName}</span>
                            <span class="label-english">${productName} Type</span>
                            <span class="required-mark">*</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4" id="subtypeCards">
                            <div class="selection-card text-center py-8 cursor-pointer subtype-card" data-subtype="‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ">
                                <div class="card-icon text-4xl">üå°Ô∏è</div>
                                <div class="card-title font-sarabun">‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</div>
                                <div class="card-subtitle font-inter">Ready to Use</div>
                            </div>
                            <div class="selection-card text-center py-8 cursor-pointer subtype-card" data-subtype="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á">
                                <div class="card-icon text-4xl">‚ùÑÔ∏è</div>
                                <div class="card-title font-sarabun">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á</div>
                                <div class="card-subtitle font-inter">Frozen Type</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = content;

            // Add event listeners for dynamic content
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', validatePage3);
            });

            container.querySelectorAll('.subtype-card').forEach(card => {
                card.addEventListener('click', () => {
                    container.querySelectorAll('.subtype-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Create hidden input for subtype
                    let hiddenInput = document.getElementById('subtype');
                    if (!hiddenInput) {
                        hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = 'subtype';
                        container.appendChild(hiddenInput);
                    }
                    hiddenInput.value = card.dataset.subtype;
                    validatePage3();
                });
            });

            validatePage3();
        }

        function updateSummary() {
            const bloodTypeNames = {
                'ffp': 'Fresh Frozen Plasma (FFP)',
                'redcell': 'Red Blood Cells',
                'cryoprecipitate': 'Cryoprecipitate'
            };

            const summaryData = {
                bloodType: bloodTypeNames[selectedBloodType] || selectedBloodType,
                patientName: document.getElementById('patientName').value,
                hn: document.getElementById('hn').value,
                wardName: document.getElementById('wardName').value,
                quantity: document.getElementById('quantity')?.value || 'N/A',
                subtype: document.getElementById('subtype')?.value || 'N/A',
                deliveryTime: selectedDeliveryTime || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                deliveryLocation: document.getElementById('deliveryLocation').value,
                reporterName: document.getElementById('reporterName').value || 'N/A',
                bloodDetails: document.getElementById('bloodDetails').value || '‡πÑ‡∏°‡πà‡∏°‡∏µ'
            };

            document.getElementById('summaryContent').innerHTML = `
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ | Patient:</span>
                    <span class="font-medium">${summaryData.patientName} (HN: ${summaryData.hn})</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ | Ward:</span>
                    <span class="font-medium">${summaryData.wardName}</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏•‡∏∑‡∏≠‡∏î | Blood Type:</span>
                    <span class="font-medium text-medical-600">${summaryData.bloodType}</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô | Quantity:</span>
                    <span class="font-medium text-lg">${summaryData.quantity} Units</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î | Details:</span>
                    <span class="font-medium">${summaryData.subtype}</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á | Delivery Time:</span>
                    <span class="font-medium text-healthcare-600">${summaryData.deliveryTime}</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á | Location:</span>
                    <span class="font-medium">${summaryData.deliveryLocation}</span>
                </div>
                <div class="summary-row">
                    <span class="font-sarabun font-semibold">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á | Reporter:</span>
                    <span class="font-medium">${summaryData.reporterName}</span>
                </div>
                ${summaryData.bloodDetails !== '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? `
                    <div class="summary-row">
                        <span class="font-sarabun font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ | Notes:</span>
                        <span class="font-medium text-gray-600">${summaryData.bloodDetails}</span>
                    </div>
                ` : ''}
            `;
        }

        async function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            const originalContent = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <div class="loading-spinner"></div> 
                <span class="font-sarabun">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                <span class="font-inter ml-2">Submitting...</span>
            `;

            const requestData = {
                request_id: requestId,
                bloodType: selectedBloodType,
                patientName: document.getElementById('patientName').value,
                hospitalNumber: document.getElementById('hn').value,
                wardName: document.getElementById('wardName').value,
                bloodDetails: document.getElementById('bloodDetails').value || '',
                deliveryTime: selectedDeliveryTime,
                deliveryLocation: document.getElementById('deliveryLocation').value,
                reporterName: document.getElementById('reporterName').value,
                quantity: document.getElementById('quantity')?.value,
                subtype: document.getElementById('subtype')?.value,
                timestamp: new Date().toISOString()
            };
            
            try {
                const response = await fetch('/api/blood_request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        showSuccessModal(`
                            <span class="font-sarabun">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span><br>
                            <span class="font-inter">Data submitted successfully</span><br>
                            <small class="font-mono text-gray-500 mt-2 block">Request ID: ${result.request_id || requestId}</small>
                        `);
                    } catch (parseError) {
                        showSuccessModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß | Data submitted successfully');
                    }
                } else {
                    let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Failed to submit data';
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (parseError) {
                        if (response.status === 500) {
                            errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå | Server error occurred';
                        }
                    }
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showErrorModal(`
                    <span class="font-sarabun">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span><br>
                    <span class="font-inter">Error occurred</span><br>
                    <small class="text-gray-600 mt-2 block">${error.message}</small>
                `);
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            }
        }

        function showSuccessModal(message) {
            document.getElementById('modalText').innerHTML = `
                <div class="text-3xl font-bold text-green-600 mb-4">
                    <span class="font-sarabun">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
                    <span class="font-inter ml-2">Success!</span>
                </div>
                <div class="text-gray-700">${message}</div>
            `;
            
            document.getElementById('modalIcon').innerHTML = `
                <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            `;
            document.getElementById('modalIcon').className = 'w-24 h-24 mx-auto mb-8 rounded-full flex items-center justify-center bg-gradient-to-br from-green-400 to-green-600 shadow-xl';
            document.getElementById('messageModal').classList.remove('hidden');
        }

        function showErrorModal(message) {
            document.getElementById('modalText').innerHTML = `
                <div class="text-3xl font-bold text-red-600 mb-4">
                    <span class="font-sarabun">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</span>
                    <span class="font-inter ml-2">Error!</span>
                </div>
                <div class="text-gray-700">${message}</div>
            `;
            
            document.getElementById('modalIcon').innerHTML = `
                <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            document.getElementById('modalIcon').className = 'w-24 h-24 mx-auto mb-8 rounded-full flex items-center justify-center bg-gradient-to-br from-red-400 to-red-600 shadow-xl';
            document.getElementById('messageModal').classList.remove('hidden');
        }
        
        function closeWindow() {
            document.getElementById('modalText').innerHTML = `
                <span class="font-sarabun">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</span><br>
                <span class="font-inter">You can close this window</span>
            `;
            document.querySelector('#messageModal button').style.display = 'none';
        }

        function setupAutocomplete(input, suggestions) {
            if (!input || !suggestions) return;
            
            let currentFocus = -1;
            
            input.addEventListener("input", function(e) {
                closeAllLists();
                
                const val = this.value;
                if (!val) return false;
                
                currentFocus = -1;
                
                const listContainer = document.createElement("div");
                listContainer.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listContainer);
                
                // Filter suggestions with improved matching
                const filteredSuggestions = suggestions.filter(item => 
                    item.toLowerCase().includes(val.toLowerCase())
                ).sort((a, b) => {
                    // Prioritize exact starts
                    const aStarts = a.toLowerCase().startsWith(val.toLowerCase());
                    const bStarts = b.toLowerCase().startsWith(val.toLowerCase());
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return a.localeCompare(b);
                });
                
                // Show max 10 suggestions
                filteredSuggestions.slice(0, 10).forEach(item => {
                    const itemDiv = document.createElement("div");
                    // Highlight matching text
                    const regex = new RegExp(`(${val})`, 'gi');
                    const highlightedText = item.replace(regex, '<strong class="text-medical-600 bg-medical-100 px-1 rounded">$1</strong>');
                    itemDiv.innerHTML = highlightedText;
                    
                    itemDiv.addEventListener("click", function() {
                        input.value = item;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                        closeAllLists();
                        
                        // Auto-fill delivery location if ward is selected
                        if (input.id === 'wardName') {
                            const deliveryInput = document.getElementById('deliveryLocation');
                            if (deliveryInput && !deliveryInput.value) {
                                deliveryInput.value = item;
                                deliveryInput.dispatchEvent(new Event('input', { bubbles: true }));
                                deliveryInput.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    });
                    
                    listContainer.appendChild(itemDiv);
                });
                
                // Show "no results" if nothing found
                if (filteredSuggestions.length === 0) {
                    const noResultDiv = document.createElement("div");
                    noResultDiv.innerHTML = '<span class="text-gray-500 italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô | No matches found</span>';
                    noResultDiv.className = 'p-4 text-center';
                    listContainer.appendChild(noResultDiv);
                }
            });
            
            input.addEventListener("keydown", function(e) {
                const items = this.parentNode.querySelector(".autocomplete-items");
                if (items) {
                    const itemDivs = items.getElementsByTagName("div");
                    if (e.keyCode === 40) { // Down arrow
                        e.preventDefault();
                        currentFocus++;
                        addActive(itemDivs);
                    } else if (e.keyCode === 38) { // Up arrow
                        e.preventDefault();
                        currentFocus--;
                        addActive(itemDivs);
                    } else if (e.keyCode === 13) { // Enter
                        e.preventDefault();
                        if (currentFocus > -1 && itemDivs[currentFocus]) {
                            itemDivs[currentFocus].click();
                        }
                    } else if (e.keyCode === 27) { // Escape
                        closeAllLists();
                    }
                }
            });
            
            // Show suggestions on focus if input has value
            input.addEventListener("focus", function() {
                if (this.value.length >= 1) {
                    this.dispatchEvent(new Event('input'));
                }
            });
            
            function addActive(items) {
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                if (items[currentFocus]) {
                    items[currentFocus].classList.add("bg-medical-50", "border-l-4", "border-medical-400");
                    items[currentFocus].scrollIntoView({ block: 'nearest' });
                }
            }
            
            function removeActive(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove("bg-medical-50", "border-l-4", "border-medical-400");
                }
            }
            
            function closeAllLists(except = null) {
                const autocompleteItems = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < autocompleteItems.length; i++) {
                    if (except !== autocompleteItems[i] && except !== input) {
                        autocompleteItems[i].parentNode.removeChild(autocompleteItems[i]);
                    }
                }
            }
            
            // Close autocomplete when clicking outside
            document.addEventListener("click", function(e) {
                if (!input.contains(e.target)) {
                    closeAllLists(e.target);
                }
            });
            
            // Close autocomplete when scrolling (mobile)
            document.addEventListener("scroll", function() {
                closeAllLists();
            });
        }
    </script>
</body>
</html>
